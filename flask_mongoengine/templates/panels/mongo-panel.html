<style>
  #flDebug .flDebugPanelContent{
    overflow:scroll;
    overflow-x:hidden;
  }

  #flDebug .mongo-raw-response-data, #flDebug .mongo-raw-command-data, #flDebug .mongo-insert-data, #flDebug .mongo-data, .mongo-op-table {
    display: none;
  }

  #flDebug .mongo-insert-data table {
    background: #676161 !important;
    display: none;
  }

  #flDebug .panelContent .mongo-op-table,
  #flDebug .panelContent .mongo-insert-data table {
    display: table;
  }

</style>

{% macro render_stats(title, queries, slow_query_limit) %}

  <h4>{{ title }}</h4>
  {% if queries %}
    <table class="mongo-op-table">
      <thead>
      <tr>
        <th>Time (ms)</th>
        <th>Size</th>
        <th>Database</th>
        <th>Operation</th>
        <th>Collection</th>
        {% if title == 'Queries' %}
          <th>Filter</th>
          <th>Sorting</th>
          <th>Skip</th>
          <th>Limit</th>
          <th>Data</th>
        {% elif title == 'Removes' %}
          <th>Filter</th>
        {% elif title == 'Inserts' %}
          <th>Data</th>
        {% elif title == 'Updates' %}
          <th>Filter</th>
          <th>Update</th>
          <th>Multi</th>
          <th>Upsert</th>
        {% elif title == 'Unknown' %}
          <th>Operation id</th>
          <th>Raw server command</th>
          <th>Raw response data</th>
        {% endif %}
        <th>Request status</th>
      </tr>
      </thead>
      <tbody>
      {% for query in queries %}
        <tr class="{{ loop.cycle('flDebugOdd','flDebugEven') }}">
          <td {% if query.time > slow_query_limit %}style="color:red;" {% endif %}>
            {{ query.time|round(3) }}
          </td>
          <td>{{ query.size|round(2) }}Kb</td>
          <td>{{ query.database }}</td>
          <td>{{ query.operation }}</td>
          <td>{{ query.collection }}</td>
          {% if title == "Queries" %}
            {% set colspan = 10 %}
            <td>
              {% if query.filter %}
                <pre>{{ query.filter|pprint }}</pre>
              {% endif %}
            </td>
            <td>{% if query.sorting %}
              <pre>{{ query.sorting|pprint }}</pre>{% endif %}
            </td>
            <td>{% if query.skip %}{{ query.skip }}{% endif %}</td>
            <td>{% if query.limit %}{{ query.limit }}{% endif %}</td>
            <td>
              <a href="javascript:void(0);" class="mongo-toggle-data"
                 data-row="mongo-data-{{ loop.index }}">Toggle</a>
            </td>
          {% elif title == "Removes" %}
            <td>
              {% if query.filter %}
                <pre>{{ query.filter|pprint }}</pre>
              {% endif %}
            </td>
          {% elif title == "Inserts" %}
            {% set colspan = 7 %}
            <td>
              <a href="javascript:void(0);" class="mongo-toggle-insert-data"
                 data-row="mongo-insert-data-{{ loop.index }}">Toggle</a>
            </td>
          {% elif title == 'Updates' %}
            {% set colspan = 9 %}
            <td>
              {% if query.filter %}
                <pre>{{ query.filter|pprint }}</pre>
              {% endif %}
            </td>
            <td>
              <pre>{{ query.updates|pprint }}</pre>
            </td>
            <td>{{ query.multi }}</td>
            <td>{{ query.upsert }}</td>
          {% elif title == 'Unknown' %}
            {% set colspan = 9 %}
            <td>{{ query.operation_id }}</td>
            <td>
              <a href="javascript:void(0);" class="mongo-toggle-raw-command-data"
                 data-row="mongo-raw-command-data-{{ loop.index }}">Toggle</a>
            </td>
            <td>
              <a href="javascript:void(0);" class="mongo-toggle-raw-response-data"
                 data-row="mongo-raw-response-data-{{ loop.index }}">Toggle</a>
            </td>
          {% endif %}
          <td>{{ query.request_status }}</td>
        </tr>

        {% if title == "Inserts" %}
          <tr class="{{ loop.cycle('flDebugOdd', 'flDebugEven') }} mongo-insert-data"
              id="mongo-insert-data-{{ loop.index }}">
            <td colspan="{{ colspan }}">
              <pre>{{ query.document|pprint }}</pre>
            </td>
          </tr>
        {% endif %}

        {% if title == "Queries" %}
          <tr class="{{ loop.cycle('flDebugOdd', 'flDebugEven') }} mongo-data" id="mongo-data-{{ loop.index }}">
            <td colspan="{{ colspan }}">
              <pre>{{ query.data|pprint }}</pre>
            </td>
          </tr>
        {% endif %}

        {% if title == "Unknown" %}
          <tr class="{{ loop.cycle('flDebugOdd', 'flDebugEven') }} mongo-raw-command-data"
              id="mongo-raw-command-data-{{ loop.index }}">
            <td colspan="{{ colspan }}">
              <pre>{{ query.server_command|pprint }}</pre>
            </td>
          </tr>
          <tr class="{{ loop.cycle('flDebugOdd', 'flDebugEven') }} mongo-raw-response-data"
              id="mongo-raw-response-data-{{ loop.index }}">
            <td colspan="{{ colspan }}">
              <pre>{{ query.raw_response|pprint }}</pre>
            </td>
          </tr>
        {% endif %}
      {% endfor %}
      </tbody>
    </table>
  {% else %}
    <p>No {{ title|lower }} recorded</p>
  {% endif %}
{% endmacro %}

{{ render_stats("Queries", queries, slow_query_limit) }}
{{ render_stats("Removes", deletes, slow_query_limit) }}
{{ render_stats("Inserts", inserts, slow_query_limit) }}
{{ render_stats("Updates", updates, slow_query_limit) }}
{{ render_stats("Unknown", unknown, slow_query_limit) }}

<script>
  (function ($) {

    $('a.mongo-toggle-data').click(function () {
      $("#" + $(this).attr('data-row')).toggle();
    });

    $('a.mongo-toggle-insert-data').click(function () {
      $("#" + $(this).attr('data-row')).toggle();
    });

    $('a.mongo-toggle-raw-command-data').click(function () {
      $("#" + $(this).attr('data-row')).toggle();
    });

    $('a.mongo-toggle-raw-response-data').click(function () {
      $("#" + $(this).attr('data-row')).toggle();
    });
  })(fldt.$);
</script>
